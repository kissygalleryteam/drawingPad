/*!build time : 2013-11-26 10:57:47 AM*/
KISSY.add("gallery/drawingPad/1.0/index",function(a,b,c,d){function e(c){var d=this;d.fatherPad=c.father,d.addAttrs({img:{setter:function(c){if(c){var d,e=this,f=document.createElement("img");return b(f).on("load",function(){e.imgWidth=f.width,e.imgHeight=f.height,e.cordX=a.isNumber(e.get("centerX"))?e.get("centerX"):.5*e.imgWidth,e.cordY=a.isNumber(e.get("centerY"))?e.get("centerY"):.5*e.imgHeight,e.render()}),d=e.fatherPad.get("proxyPrefix")+(/http:\/\//.test(c)?c:"http://"+c),f.src=d,e.img=f,d}},getter:function(a){return a}},centerX:{value:null,setter:function(a){return a},getter:function(a){return a}},centerY:{value:null,setter:function(a){return a},getter:function(a){return a}},rotate:{value:0,setter:function(a){return a},getter:function(a){return a}},scale:{value:1,setter:function(a){return a},getter:function(a){return a}},cusClass:{value:null,setter:function(a){return a},getter:function(a){return a}}}),e.superclass.constructor.call(d,c),d.canvasEl=document.createElement("canvas"),d.canvasEl.innerHTML="\u60a8\u7684\u6d4f\u89c8\u5668\u7248\u672c\u8fc7\u4f4e\uff0c\u8bf7\u5347\u7ea7";var f=b('<div class="_drawingPad_canvasLayer"></div>').append(d.canvasEl).css("position","absolute").css("top","0px").css("left","0px"),g=(f.one("canvas"),b(c.wrapper)),h=g.one("."+i),j=d.get("img");f.one("canvas").css("background","none"),h?h.before(f):g.append(f),d.fatherPad.flashCanvasEnabled&&FlashCanvas.initElement(d.canvasEl),c.cusClass&&f.addClass(c.cusClass),d.canvasCtx=d.canvasEl.getContext("2d"),j||(d.imgWidth=d.fatherPad.width,d.imgHeight=d.fatherPad.height),d.cordX=a.isNumber(d.get("centerX"))?d.get("centerX"):.5*d.imgWidth,d.cordY=a.isNumber(d.get("centerY"))?d.get("centerY"):.5*d.imgHeight,d.canvasEl.width=c.width,d.canvasEl.height=c.height}function f(a){if(a.height&&a.width&&a.wrapper){var b=this;b.canvasSupport=g(),b.flashCanvasEnabled=h(),b.init.call(b,a)}}function g(){var a=document.createElement("canvas");return a.getContext&&a.getContext("2d")}function h(){return"undefined"!=typeof FlashCanvas}var i="_drawingPad_interact",j="http://www.tmall.com/go/rgn/tbs-proxy.php?file=";return a.extend(e,d,{render:function(){var a=this,b=a.canvasCtx,c=a.img,d=a.imgWidth,e=a.imgHeight,f=a.get("scale"),g=a.get("rotate");return b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,a.canvasEl.width,a.canvasEl.height),d?(b.setTransform(1,0,0,1,a.cordX,a.cordY),b.rotate(g*Math.PI/180),b.drawImage(c,0,0,d,a.imgHeight,-.5*d*f,-.5*e*f,d*f,e*f),a):a},activeInteract:function(){this.fatherPad.interactDoingLayer=this,this.fatherPad._updateController()},deactiveInteract:function(){this.fatherPad.interactDoingLayer==this&&(this.fatherPad.interactDoingLayer=null,this.fatherPad._updateController())}}),a.extend(f,d,{init:function(a){function c(a,b){function c(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}function e(a,b,c){return[a*Math.cos(c)-b*Math.sin(c),a*Math.sin(c)+b*Math.cos(c)]}var f=d.interactDoingLayer;if(!f)return null;var g,h={position:null,info:null},i=f.get("scale"),j=f.cordX-.5*f.imgWidth*i,k=f.cordX+.5*f.imgWidth*i,l=f.cordY-.5*f.imgHeight*i,m=f.cordY+.5*f.imgHeight*i,n=f.get("rotate"),o=0-n*Math.PI/180,p=a-f.cordX,q=b-f.cordY,r=e(p,q,o),s=r[0],t=r[1],u=f.cordX+s,v=f.cordY+t,w=["ul","t","ur","r","lr","b","ll","l"];if(c(u,v,j,l)<10?g=0:c(u,v,k,l)<10?g=2:c(u,v,k,m)<10?g=4:c(u,v,j,m)<10?g=6:h.position=u>=j&&k>=u&&m>=v&&v>=l?"in":c(0,-30-.5*f.imgHeight*i,s,t)<10?"dot":"out",void 0!==g){var x,y=0;rotationRate=n/90,y=Math.floor(rotationRate)==rotationRate?2*rotationRate:2*Math.floor(rotationRate)+1,x=g+y,x=x>=8?x-8:x,h.position=w[x]}return h.shadowMouse=r,h}var d=this;d.addAttrs({height:{value:0,setter:function(a){return a},getter:function(a){return a}},width:{value:0,setter:function(a){return a},getter:function(a){return a}},wrapper:{value:null,setter:function(a){return a},getter:function(a){return a}},proxyPrefix:{value:j,setter:function(a){return a},getter:function(a){return a}}}),f.superclass.constructor.call(d,a),d.layers=[],d.interactDoingLayer=null,d.interactCaptureLayer=null,b(d.get("wrapper")).empty().css("position","relative").css("height",d.get("height")+"px").css("width",d.get("width")+"px"),d.interactCaptureLayer=d.addLayer({img:null,cusClass:i});var e,g,h;b.one(document).on("mouseup",function(){e=null}),b(d.interactCaptureLayer.canvasEl).on("mousedown",function(a){var f=d.interactDoingLayer;if(f){var i=void 0!=a.offsetX?a.offsetX:a.pageX-b(a.target).offset().left,j=void 0!=a.offsetY?a.offsetY:a.pageY-b(a.target).offset().top,k=c(i,j).position;switch(e=!0,k){case"in":e="move",g=i,h=j;break;case"dot":e="rotate";break;case"ul":case"t":case"ur":case"r":case"lr":case"b":case"ll":case"l":e="scale";break;default:e=null}}}).on("mousemove",function(a){var f=d.interactDoingLayer;if(f){var i=void 0!=a.offsetX?a.offsetX:a.pageX-b(a.target).offset().left,j=void 0!=a.offsetY?a.offsetY:a.pageY-b(a.target).offset().top,k=c(i,j),l=k.position,m=(k.info,k.shadowMouse),n=(d.interactCaptureLayer.canvasEl,"auto"),o={"in":"move",out:"auto",dot:"url('http://gtms01.alicdn.com/tps/i1/T1TBtSFbtiXXbzrQHa-22-22.gif'),pointer",ul:"nw-resize",ur:"ne-resize",ll:"ne-resize",lr:"nw-resize",t:"n-resize",b:"n-resize",l:"e-resize",r:"e-resize"};if("move"==e)f.cordX+=i-g,f.cordY+=j-h,f.render(),d._updateController(),g=i,h=j;else if("scale"==e){var p,q,r=f.imgWidth,s=f.imgHeight,t=(f.cordX,f.cordY,1),p=Math.abs(m[0]/(.5*r));q=Math.abs(m[1]/(.5*s)),t=Math.min(p,q),f.set("scale",t),f.render(),d._updateController()}else if("rotate"==e){var u,v=i-f.cordX,w=-j+f.cordY;u=0==w&&0>=v?270:0==w&&v>0?90:w>0?180*Math.atan(v/w)/Math.PI:180*Math.atan(v/w)/Math.PI+180,f.set("rotate",u),f.render(),d._updateController()}else n=o[l]||n,b(d.get("wrapper")).css("cursor",n)}})},addLayer:function(b){var c=new e(a.mix(b,{father:this,height:this.get("height"),width:this.get("width"),wrapper:this.get("wrapper")}));return this.layers.push(c),c},deactiveInteract:function(){this.interactDoingLayer=null,this._updateController()},_clearCapture:function(){var a=this.interactCaptureLayer.canvasCtx;a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,this.get("width"),this.get("height"))},_updateController:function(){function a(a,b,c,d){a.fillRect(c-b/2,d-b/2,b,b)}var b=this,c=b.interactCaptureLayer.canvasCtx;if(b.interactDoingLayer){var d=6,e="#7777FF",f="#7777FF",g=2,h="square",i=b.interactDoingLayer.get("rotate"),j=b.interactDoingLayer.get("scale"),k=b.interactDoingLayer.cordX,l=b.interactDoingLayer.cordY,m=b.interactDoingLayer.imgWidth*j,n=b.interactDoingLayer.imgHeight*j,o=0-.5*m,p=0+.5*m,q=0-.5*n,r=0+.5*n;b._clearCapture(),c.setTransform(1,0,0,1,k,l),c.rotate(i*Math.PI/180),c.beginPath(),c.lineWidth=g,c.strokeStyle=e,c.lineCap=h,c.fillStyle=f,c.moveTo(o,q),c.lineTo(p,q),c.lineTo(p,r),c.lineTo(o,r),c.lineTo(o,q),c.stroke(),c.closePath(),a(c,d,o,q),a(c,d,p,q),a(c,d,p,r),a(c,d,o,r),a(c,d,o,q);var s=4;c.beginPath(),c.moveTo(0,q),c.lineTo(0,q-30),c.stroke(),c.closePath(),c.beginPath(),c.arc(0,q-30,s,0,2*Math.PI),c.fill(),c.closePath()}else b._clearCapture()},getMergedData:function(a,b){var c,d=this,b=b||2e3,e=this.interactCaptureLayer.canvasEl,f=this.interactCaptureLayer.canvasCtx;d.deactiveInteract();for(var g=1;g<d.layers.length;g++){var h=d.layers[g].canvasEl;f.drawImage(h,0,0)}try{if(d.flashCanvasEnabled)setTimeout(function(){c=e.toDataURL("image/png"),d._clearCapture(),a(c)},b);else{if(c=e.toDataURL("image/png"),d._clearCapture(),!a)return c;a(c)}}catch(i){return console.log("error when fetching data, maybe due to cross-domain issue"),""}}},{}),f},{requires:["node","dom","base"]});