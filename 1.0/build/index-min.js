/*!build time : 2013-11-21 5:01:00 PM*/
KISSY.add("gallery/drawingPad/1.0/index",function(a,b){function c(a){var c=b('<div class="_drawingPad_canvasLayer"><canvas></canvas><div>').css("position","absolute").css("top","0px").css("left","0px"),d=c.one("canvas"),f=a.wrapper.one("."+e);c.one("canvas").css("background","none"),f?f.before(c):a.wrapper.append(c),this.fatherPad=a.father,this.canvasEl=d.getDOMNode(),this.canvasCtx=this.canvasEl.getContext("2d"),this.scaleRate=a.scale||1,this.rotateDeg=a.rotate||0,this.img=a.img,this.img?(this.imgWidth=a.img.width,this.imgHeight=a.img.height):(this.imgWidth=this.fatherPad.width,this.imgHeight=this.fatherPad.height),this.cordX=a.centerX||.5*this.imgWidth,this.cordY=a.centerY||.5*this.imgHeight,this.canvasEl.width=a.width,this.canvasEl.height=a.height,a.class&&c.addClass(a.class)}function d(a){function c(a,b){function c(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}function e(a,b,c){return[a*Math.cos(c)-b*Math.sin(c),a*Math.sin(c)+b*Math.cos(c)]}var f=d.interactDoingLayer;if(!f)return null;var g,h={position:null,info:null},i=f.scaleRate,j=f.cordX-.5*f.imgWidth*i,k=f.cordX+.5*f.imgWidth*i,l=f.cordY-.5*f.imgHeight*i,m=f.cordY+.5*f.imgHeight*i,n=f.rotateDeg,o=0-n*Math.PI/180,p=a-f.cordX,q=b-f.cordY,r=e(p,q,o),s=r[0],t=r[1],u=f.cordX+s,v=f.cordY+t,w=["ul","t","ur","r","lr","b","ll","l"];if(c(u,v,j,l)<10?g=0:c(u,v,k,l)<10?g=2:c(u,v,k,m)<10?g=4:c(u,v,j,m)<10?g=6:h.position=u>=j&&k>=u&&m>=v&&v>=l?"in":c(0,-30-.5*f.imgHeight*i,s,t)<10?"dot":"out",void 0!==g){var x,y=0;rotationRate=n/90,y=Math.floor(rotationRate)==rotationRate?2*rotationRate:2*Math.floor(rotationRate)+1,x=g+y,x=x>=8?x-8:x,h.position=w[x]}return h.shadowMouse=r,h}if(a.height&&a.width&&a.wrapper){var d=this;d.height=a.height,d.width=a.width,d.wrapper=b(a.wrapper),d.layers=[],d.interactDoingLayer=null,d.interactCaptureLayer=null,d.wrapper.empty().css("position","relative").css("height",d.height+"px").css("width",d.width+"px"),d.interactCaptureLayer=d.addLayer({img:null,"class":e});var f,g,h;b.one(document).on("mouseup",function(){f=null}),b(d.interactCaptureLayer.canvasEl).on("mousedown",function(a){var b=d.interactDoingLayer;if(b){var e=a.offsetX,i=a.offsetY,j=c(e,i).position;switch(f=!0,j){case"in":f="move",g=e,h=i;break;case"dot":f="rotate";break;case"ul":case"t":case"ur":case"r":case"lr":case"b":case"ll":case"l":f="scale";break;default:f=null}}}).on("mousemove",function(a){var e=d.interactDoingLayer;if(e){var i=a.offsetX,j=a.offsetY,k=c(i,j),l=k.position,m=(k.info,k.shadowMouse),n=d.interactCaptureLayer.canvasEl,o="auto",p={"in":"move",out:"auto",dot:"url('icon_rotate.gif'),pointer",ul:"nw-resize",ur:"ne-resize",ll:"ne-resize",lr:"nw-resize",t:"n-resize",b:"n-resize",l:"e-resize",r:"e-resize"};if("move"==f)e.cordX+=a.offsetX-g,e.cordY+=a.offsetY-h,e.render(),d._updateController(),g=i,h=j;else if("scale"==f){var q,r,s=e.imgWidth,t=e.imgHeight,u=(e.cordX,e.cordY,1),q=Math.abs(m[0]/(.5*s));r=Math.abs(m[1]/(.5*t)),u=Math.min(q,r),e.scaleRate=u,e.render(),d._updateController()}else if("rotate"==f){var v,w=i-e.cordX,x=-j+e.cordY;v=0==x&&0>=w?270:0==x&&w>0?90:x>0?180*Math.atan(w/x)/Math.PI:180*Math.atan(w/x)/Math.PI+180,e.rotateDeg=v,e.render(),d._updateController()}else o=p[l]||o,b(n).css("cursor",o)}})}}var e="_drawingPad_interact";return a.augment(c,{render:function(){var a=this,b=this.canvasCtx,c=this.img,d=this.scaleRate,e=this.rotateDeg;return b.setTransform(1,0,0,1,0,0),b.clearRect(0,0,a.canvasEl.width,a.canvasEl.height),b.setTransform(1,0,0,1,a.cordX,a.cordY),b.rotate(e*Math.PI/180),"undefined"!=typeof FlashCanvas?b.loadImage(c,function(){b.drawImage(c,0,0,a.imgWidth,a.imgHeight,-.5*a.imgWidth*d,-.5*a.imgHeight*d,a.imgWidth*d,a.imgHeight*d)}):b.drawImage(c,0,0,a.imgWidth,a.imgHeight,-.5*a.imgWidth*d,-.5*a.imgHeight*d,a.imgWidth*d,a.imgHeight*d),a},activeInteract:function(){this.fatherPad.interactDoingLayer=this,this.fatherPad._updateController()},deactiveInteract:function(){this.fatherPad.interactDoingLayer==this&&(this.fatherPad.interactDoingLayer=null,this.fatherPad._updateController())}}),a.augment(d,{addLayer:function(b){var d=new c(a.mix(b,{father:this,height:this.height,width:this.width,wrapper:this.wrapper}));return this.layers.push(d),d},deactiveInteract:function(){this.interactDoingLayer=null,this._updateController()},_clearCapture:function(){var a=this.interactCaptureLayer.canvasCtx;a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,this.width,this.height)},_updateController:function(){function a(a,b,c,d){a.fillRect(c-b/2,d-b/2,b,b)}var b=this,c=b.interactCaptureLayer.canvasCtx;if(b.interactDoingLayer){var d=6,e="#7777FF",f="#7777FF",g=2,h="square",i=b.interactDoingLayer.rotateDeg,j=b.interactDoingLayer.scaleRate,k=b.interactDoingLayer.cordX,l=b.interactDoingLayer.cordY,m=b.interactDoingLayer.imgWidth*j,n=b.interactDoingLayer.imgHeight*j,o=0-.5*m,p=0+.5*m,q=0-.5*n,r=0+.5*n;b._clearCapture(),c.setTransform(1,0,0,1,k,l),c.rotate(i*Math.PI/180),c.beginPath(),c.lineWidth=g,c.strokeStyle=e,c.lineCap=h,c.fillStyle=f,c.moveTo(o,q),c.lineTo(p,q),c.lineTo(p,r),c.lineTo(o,r),c.lineTo(o,q),c.stroke(),c.closePath(),a(c,d,o,q),a(c,d,p,q),a(c,d,p,r),a(c,d,o,r),a(c,d,o,q);var s=4;c.beginPath(),c.moveTo(0,q),c.lineTo(0,q-30),c.stroke(),c.closePath(),c.beginPath(),c.arc(0,q-30,s,0,2*Math.PI),c.fill(),c.closePath()}else b._clearCapture()},getMergedData:function(){var a,b=this.interactCaptureLayer.canvasEl,c=this.interactCaptureLayer.canvasCtx;this.deactiveInteract();for(var d=1;d<this.layers.length;d++){var e=this.layers[d].canvasEl;c.drawImage(e,0,0)}return a=b.toDataURL("image/png"),this._clearCapture(),a}}),d},{requires:["node","dom","base"]});